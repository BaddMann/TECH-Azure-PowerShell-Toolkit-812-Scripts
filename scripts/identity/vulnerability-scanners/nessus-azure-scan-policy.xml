<?xml version="1.0" encoding="UTF-8"?>
<NessusPolicy>
  <policyName>Azure Enterprise Security Scan Policy</policyName>
  <description>Comprehensive security scanning policy for Azure enterprise environments including VMs, web applications, databases, and cloud services</description>
  <version>2.0.0</version>
  <lastUpdated>2025-06-16</lastUpdated>
  
  <!-- Basic Settings -->
  <basicSettings>
    <policyType>Advanced Scan</policyType>
    <folder>Azure Policies</folder>
    <scanner>Any</scanner>
    <owner>security-team@company.com</owner>
    <visibility>Private</visibility>
  </basicSettings>
  
  <!-- Discovery Settings -->
  <discovery>
    <hostDiscovery>
      <portScanTCP>1-65535</portScanTCP>
      <portScanUDP>53,67,68,69,123,137,138,161,500,514,1434</portScanUDP>
      <icmpPing>true</icmpPing>
      <tcpPing>true</tcpPing>
      <arpPing>true</arpPing>
      <considerUnscannablePortsAsClosed>true</considerUnscannablePortsAsClosed>
    </hostDiscovery>
    
    <serviceDiscovery>
      <probeAllPorts>true</probeAllPorts>
      <serviceRecognition>true</serviceRecognition>
      <searchForSSLServices>true</searchForSSLServices>
      <deterministicOrder>Ports, Protocols, Common ports, Web servers</deterministicOrder>
    </serviceDiscovery>
  </discovery>
  
  <!-- Assessment Settings -->
  <assessment>
    <general>
      <enableSafeChecks>true</enableSafeChecks>
      <avoidPotentiallyHarmfulTests>false</avoidPotentiallyHarmfulTests>
      <enablePotentiallyDisruptiveTests>false</enablePotentiallyDisruptiveTests>
      <scanNetworkPrinters>false</scanNetworkPrinters>
      <scanEmbeddedWebServers>true</scanEmbeddedWebServers>
      <maxSimultaneousHostsPerScan>5</maxSimultaneousHostsPerScan>
      <maxSimultaneousChecksPerHost>5</maxSimultaneousChecksPerHost>
      <networkReceiveTimeout>5</networkReceiveTimeout>
      <maxChecksPerHost>5</maxChecksPerHost>
      <readTimeout>5</readTimeout>
    </general>
    
    <!-- Azure-Specific Settings -->
    <azureSpecific>
      <scanAzureVMs>true</scanAzureVMs>
      <scanAzureWebApps>true</scanAzureWebApps>
      <scanAzureStorage>true</scanAzureStorage>
      <scanAzureSQL>true</scanAzureSQL>
      <checkAzureNSGs>true</checkAzureNSGs>
      <validateAzureEncryption>true</validateAzureEncryption>
      <auditAzureIAM>true</auditAzureIAM>
    </azureSpecific>
  </assessment>
  
  <!-- Report Settings -->
  <report>
    <format>HTML</format>
    <verbosity>Normal</verbosity>
    <outputFileName>Azure_Security_Scan_{timestamp}</outputFileName>
    <showMissingPatches>true</showMissingPatches>
    <processingComments>true</processingComments>
  </report>
  
  <!-- Plugin Family Settings -->
  <pluginFamilies>
    <!-- Core Security Families -->
    <family name="Backdoors" enabled="true" />
    <family name="Brute force attacks" enabled="true" />
    <family name="CGI abuses" enabled="true" />
    <family name="CGI abuses : XSS" enabled="true" />
    <family name="CISCO" enabled="false" />
    <family name="Databases" enabled="true" />
    <family name="Default Unix Accounts" enabled="true" />
    <family name="Denial of Service" enabled="false" />
    <family name="DNS" enabled="true" />
    <family name="FTP" enabled="true" />
    <family name="Firewalls" enabled="true" />
    <family name="Gain a shell remotely" enabled="true" />
    <family name="General" enabled="true" />
    <family name="Malware" enabled="true" />
    <family name="Misc." enabled="true" />
    <family name="Netware" enabled="false" />
    <family name="Peer-To-Peer File Sharing" enabled="true" />
    <family name="Policy Compliance" enabled="true" />
    <family name="Port scanners" enabled="true" />
    <family name="SCADA" enabled="true" />
    <family name="Service detection" enabled="true" />
    <family name="Settings" enabled="true" />
    <family name="SMTP problems" enabled="true" />
    <family name="SNMP" enabled="true" />
    <family name="SQL Injection" enabled="true" />
    <family name="Tenable.ot" enabled="false" />
    <family name="Web Servers" enabled="true" />
    <family name="Windows" enabled="true" />
    <family name="Windows : Microsoft Bulletins" enabled="true" />
    <family name="Windows : User management" enabled="true" />
    
    <!-- Azure-Specific Plugin Families -->
    <family name="Azure" enabled="true" />
    <family name="Cloud Security" enabled="true" />
    <family name="Amazon Web Services" enabled="false" />
    <family name="Google Cloud Platform" enabled="false" />
  </pluginFamilies>
  
  <!-- Individual Plugin Settings -->
  <individualPlugins>
    <!-- Critical Azure Security Plugins -->
    <plugin id="117463" name="Azure VM Agent Missing" enabled="true" />
    <plugin id="117464" name="Azure VM Encryption Not Enabled" enabled="true" />
    <plugin id="117465" name="Azure Storage Account Publicly Accessible" enabled="true" />
    <plugin id="117466" name="Azure SQL Database Encryption Not Enabled" enabled="true" />
    <plugin id="117467" name="Azure Network Security Group Default Rules" enabled="true" />
    <plugin id="117468" name="Azure Key Vault Access Policy Misconfiguration" enabled="true" />
    <plugin id="117469" name="Azure Application Gateway SSL Policy" enabled="true" />
    <plugin id="117470" name="Azure Load Balancer Health Probe Configuration" enabled="true" />
    
    <!-- Web Application Security -->
    <plugin id="10107" name="HTTP Server Type and Version" enabled="true" />
    <plugin id="11011" name="Web Server Default Content" enabled="true" />
    <plugin id="39468" name="Web Application Potentially Vulnerable to Clickjacking" enabled="true" />
    <plugin id="84502" name="Web Server Uses Basic Authentication Without HTTPS" enabled="true" />
    <plugin id="45410" name="Web Application Cookies Not Marked HTTPOnly" enabled="true" />
    <plugin id="49218" name="Web Application Cookies Not Marked Secure" enabled="true" />
    
    <!-- SSL/TLS Security -->
    <plugin id="21643" name="SSL Certificate Cannot Be Trusted" enabled="true" />
    <plugin id="51192" name="SSL Certificate Signed Using Weak Hashing Algorithm" enabled="true" />
    <plugin id="65821" name="SSL RC4 Cipher Suites Supported (Bar Mitzvah)" enabled="true" />
    <plugin id="78479" name="SSL/TLS Diffie-Hellman Modulus <= 1024 Bits (Logjam)" enabled="true" />
    <plugin id="83875" name="SSL/TLS EXPORT_RSA <= 512-bit Cipher Suites Supported (FREAK)" enabled="true" />
    
    <!-- Database Security -->
    <plugin id="10719" name="Microsoft SQL Server tcp/1433 Accessible" enabled="true" />
    <plugin id="10881" name="SSH Protocol Versions Supported" enabled="true" />
    <plugin id="22964" name="Service Detection" enabled="true" />
    <plugin id="35291" name="Microsoft SQL Server Unsupported Version Detection" enabled="true" />
    
    <!-- Network Security -->
    <plugin id="11936" name="OS Identification" enabled="true" />
    <plugin id="19506" name="Nessus Scan Information" enabled="true" />
    <plugin id="10863" name="SSL Certificate Information" enabled="true" />
    <plugin id="42873" name="SSL Medium Strength Cipher Suites Supported" enabled="true" />
  </individualPlugins>
  
  <!-- Advanced Settings -->
  <advancedSettings>
    <!-- Network Settings -->
    <networking>
      <reduceConnectionsOnConnRefused>true</reduceConnectionsOnConnRefused>
      <networkConnectionTimeout>60</networkConnectionTimeout>
      <networkReadTimeout>120</networkReadTimeout>
      <maxHostsParallel>30</maxHostsParallel>
      <maxChecksParallel>10</maxChecksParallel>
    </networking>
    
    <!-- Performance Settings -->
    <performance>
      <autoThrottleNetworkIO>true</autoThrottleNetworkIO>
      <adaptiveTimeout>true</adaptiveTimeout>
      <optimizeScanDuration>true</optimizeScanDuration>
      <scanPerformanceMode>Normal</scanPerformanceMode>
    </performance>
    
    <!-- Azure-Specific Advanced Settings -->
    <azureAdvanced>
      <useAzureServicePrincipal>true</useAzureServicePrincipal>
      <azureSubscriptionId>{subscription-id}</azureSubscriptionId>
      <azureTenantId>{tenant-id}</azureTenantId>
      <azureClientId>{client-id}</azureClientId>
      <scanAzureResourceGroups>all</scanAzureResourceGroups>
      <validateAzurePolicyCompliance>true</validateAzurePolicyCompliance>
      <checkAzureSecurityCenter>true</checkAzureSecurityCenter>
    </azureAdvanced>
  </advancedSettings>
  
  <!-- Credentials for Authenticated Scanning -->
  <credentials>
    <!-- Windows Credentials -->
    <windowsCredentials>
      <authMethod>Password</authMethod>
      <username>{windows-username}</username>
      <password>{windows-password}</password>
      <domain>{windows-domain}</domain>
      <additionalSettings>
        <neverSendNTLMv1>true</neverSendNTLMv1>
        <startRemoteRegistry>false</startRemoteRegistry>
      </additionalSettings>
    </windowsCredentials>
    
    <!-- SSH Credentials -->
    <sshCredentials>
      <authMethod>Public Key</authMethod>
      <username>{ssh-username}</username>
      <privateKey>{ssh-private-key}</privateKey>
      <passphrase>{ssh-passphrase}</passphrase>
      <additionalSettings>
        <escalatePrivileges>sudo</escalatePrivileges>
        <sudoPassword>{sudo-password}</sudoPassword>
        <preferredPort>22</preferredPort>
        <clientVersion>OpenSSH_5.0</clientVersion>
      </additionalSettings>
    </sshCredentials>
    
    <!-- Database Credentials -->
    <databaseCredentials>
      <sqlServer>
        <loginMethod>SQL Server Authentication</loginMethod>
        <username>{sql-username}</username>
        <password>{sql-password}</password>
        <instanceName>{sql-instance}</instanceName>
      </sqlServer>
      
      <mysql>
        <username>{mysql-username}</username>
        <password>{mysql-password}</password>
        <loginAsRoot>false</loginAsRoot>
      </mysql>
    </databaseCredentials>
    
    <!-- Azure API Credentials -->
    <azureCredentials>
      <authMethod>Service Principal</authMethod>
      <tenantId>{azure-tenant-id}</tenantId>
      <clientId>{azure-client-id}</clientId>
      <clientSecret>{azure-client-secret}</clientSecret>
      <subscriptionId>{azure-subscription-id}</subscriptionId>
    </azureCredentials>
  </credentials>
  
  <!-- Compliance Checks -->
  <complianceChecks>
    <cis>
      <cisAzureFoundationsBenchmark>true</cisAzureFoundationsBenchmark>
      <cisWindowsServerBenchmark>true</cisWindowsServerBenchmark>
      <cisUbuntuLinuxBenchmark>true</cisUbuntuLinuxBenchmark>
    </cis>
    
    <nist>
      <nistCybersecurityFramework>true</nistCybersecurityFramework>
      <nist80053>true</nist80053>
    </nist>
    
    <iso>
      <iso27001>true</iso27001>
    </iso>
    
    <pci>
      <pciDss>true</pciDss>
    </pci>
    
    <sox>
      <sarbanesOxley>true</sarbanesOxley>
    </sox>
  </complianceChecks>
  
  <!-- Custom Plugin Preferences -->
  <pluginPreferences>
    <!-- Web Application Testing -->
    <preference name="HTTP login page">/{login_page}</preference>
    <preference name="HTTP login form">/{login_form}</preference>
    <preference name="HTTP reauth delay (seconds)">0</preference>
    <preference name="Follow 30x redirections (# of levels)">2</preference>
    <preference name="Number of pages to crawl">25</preference>
    <preference name="Web application tests enabled">Cross Site Scripting, SQL Injection, Code Injection</preference>
    
    <!-- Azure Specific Preferences -->
    <preference name="Azure Resource Manager endpoint">https://management.azure.com/</preference>
    <preference name="Azure Active Directory endpoint">https://login.microsoftonline.com/</preference>
    <preference name="Enable Azure Security Center integration">yes</preference>
    <preference name="Scan Azure Key Vault configurations">yes</preference>
    <preference name="Validate Azure Storage account encryption">yes</preference>
    
    <!-- SSL Certificate Testing -->
    <preference name="Check SSL certificate validity">yes</preference>
    <preference name="Check SSL certificate chains">yes</preference>
    <preference name="Enumerate SSL ciphers">yes</preference>
    <preference name="Test SSL cipher strength">yes</preference>
    
    <!-- Database Testing -->
    <preference name="Login configurations file">{db_config_file}</preference>
    <preference name="SQL Server : Use WMI to retrieve patch level">yes</preference>
    <preference name="Test default accounts (safe checks)">yes</preference>
  </pluginPreferences>
  
  <!-- Scan Targets -->
  <targets>
    <target>
      <name>Azure Production Environment</name>
      <description>Production Azure resources including VMs, web apps, and databases</description>
      <hosts>
        <range>10.0.0.0/16</range>
        <range>10.1.0.0/16</range>
        <host>prod-web-app.azurewebsites.net</host>
        <host>prod-sql-server.database.windows.net</host>
      </hosts>
      <excludes>
        <host>10.0.1.50</host>
        <range>10.0.255.0/24</range>
      </excludes>
    </target>
    
    <target>
      <name>Azure Staging Environment</name>
      <description>Staging Azure resources for pre-production testing</description>
      <hosts>
        <range>10.2.0.0/16</range>
        <host>staging-web-app.azurewebsites.net</host>
        <host>staging-sql-server.database.windows.net</host>
      </hosts>
    </target>
  </targets>
  
  <!-- Scan Schedule -->
  <schedule>
    <enabled>true</enabled>
    <timezone>UTC</timezone>
    <frequency>Weekly</frequency>
    <startTime>02:00</startTime>
    <dayOfWeek>Sunday</dayOfWeek>
    <notifications>
      <onStart>false</onStart>
      <onCompletion>true</onCompletion>
      <onError>true</onError>
      <emailRecipients>
        <recipient>security-team@company.com</recipient>
        <recipient>infrastructure-team@company.com</recipient>
      </emailRecipients>
    </notifications>
  </schedule>
  
  <!-- Risk Rating Settings -->
  <riskRating>
    <useCustomRiskFactor>true</useCustomRiskFactor>
    <customRiskFactors>
      <criticalSeverity>4.0</criticalSeverity>
      <highSeverity>3.0</highSeverity>
      <mediumSeverity>2.0</mediumSeverity>
      <lowSeverity>1.0</lowSeverity>
      <infoSeverity>0.0</infoSeverity>
    </customRiskFactors>
    <businessCriticalityMultiplier>
      <production>2.0</production>
      <staging>1.5</staging>
      <development>1.0</development>
    </businessCriticalityMultiplier>
  </riskRating>
  
  <!-- Integration Settings -->
  <integration>
    <siem>
      <enabled>true</enabled>
      <format>CEF</format>
      <destination>siem.company.com:514</destination>
      <protocol>TCP</protocol>
    </siem>
    
    <ticketing>
      <enabled>true</enabled>
      <system>ServiceNow</system>
      <endpoint>https://company.service-now.com/api</endpoint>
      <apiKey>{servicenow-api-key}</apiKey>
      <autoCreateTickets>true</autoCreateTickets>
      <minimumSeverity>Medium</minimumSeverity>
    </ticketing>
    
    <azureSecurityCenter>
      <enabled>true</enabled>
      <importFindings>true</importFindings>
      <exportResults>true</exportResults>
      <workspaceId>{azure-security-center-workspace-id}</workspaceId>
    </azureSecurityCenter>
  </integration>
  
  <!-- Custom Commands -->
  <customCommands>
    <preCompileCommands>
      <command>echo "Starting Azure security scan at $(date)"</command>
      <command>az account show --query name -o tsv</command>
    </preCompileCommands>
    
    <postCompileCommands>
      <command>echo "Azure security scan completed at $(date)"</command>
      <command>curl -X POST -H "Content-Type: application/json" -d '{"status":"completed","timestamp":"$(date)"}' {webhook-url}</command>
    </postCompileCommands>
  </customCommands>
  
</NessusPolicy>